# `diff` Command

The `diff` command lets you compare two RBAC scan outputs and detect permission drift between them. Itâ€™s ideal for CI/CD checks, audits, and regression tracking.

---

## âš–ï¸ Basic Usage

```bash
permiflow diff \
  --before ./audit/scan1/report.json \
  --after ./audit/scan2/report.json
```

This compares two JSON reports generated by the `scan` command and outputs a change summary to stdout.

---

## ğŸ  Key Flags

| Flag        | Type     | Description                                                              |
| ----------- | -------- | ------------------------------------------------------------------------ |
| `--before`  | `string` | Path to older scan (baseline) JSON report                                |
| `--after`   | `string` | Path to newer/current JSON report                                        |
| `--out-dir` | `string` | Optional directory to write Markdown and JSON diffs                      |
| `--fail-on` | `string` | Fail with exit code 1 if diff includes new binding(s) at this risk level |

---

## âœ… Risk-Aware Failures

Use `--fail-on` in CI/CD to enforce security gates:

```bash
permiflow diff \
  --before baseline.json \
  --after latest.json \
  --fail-on high
```

If new HIGH risk bindings are detected, the command:

- Prints a summary
- Returns exit code 1
- Avoids writing files (unless `--out-dir` is set)

---

## ğŸ“„ Output Files (Optional)

If `--out-dir` is provided, Permiflow writes:

- `diff.md` â€“ Human-readable Markdown diff
- `diff.json` â€“ Structured JSON diff output

These files include additions, removals, and modified bindings with risk levels.

---

## ğŸŒ Real-World Scenarios

### 1. Weekly Drift Audits

```bash
permiflow diff \
  --before weekly-snapshot-1.json \
  --after weekly-snapshot-2.json \
  --out-dir ./weekly-diffs
```

### 2. Post-Deployment CI Checks

```bash
permiflow diff \
  --before ./tmp/pre-deploy.json \
  --after ./tmp/post-deploy.json \
  --fail-on medium
```

---

## ğŸ” What Counts as a "Change"?

Permiflow compares bindings using a unique key based on:

- Subject + Kind
- Namespace + Role
- Scope

Then it evaluates if **verbs**, **resources**, or **risk level** changed.

---

## ğŸ”§ Tips

- Use consistent `--prefix` when scanning to make filenames predictable.
- Combine `scan` and `diff` in Makefiles or CI pipelines.

---

Next up: [history.md](./history.md) â€” understanding scan tracking and metadata.
